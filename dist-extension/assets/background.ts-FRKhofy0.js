let ws=null,wsReconnectAttempts=0;const MAX_RECONNECT_ATTEMPTS=10,WS_URL="ws://localhost:8129",ALARM_WS_RECONNECT="ws-reconnect",ALARM_SESSION_HEALTH="session-health",connectedClients=new Set,MAX_CONSOLE_LOGS=1e3,consoleLogs=[];function addConsoleLog(e){consoleLogs.push(e),consoleLogs.length>MAX_CONSOLE_LOGS&&consoleLogs.shift(),(ws==null?void 0:ws.readyState)===WebSocket.OPEN&&sendToWebSocket({type:"browser-console-log",entry:e})}function getConsoleLogs(e){let o=[...consoleLogs];e.level&&e.level!=="all"&&(o=o.filter(t=>t.level===e.level)),e.since&&(o=o.filter(t=>t.timestamp>=e.since)),e.tabId&&(o=o.filter(t=>t.tabId===e.tabId));const n=e.limit||100;return o.slice(-n)}async function handleBrowserExecuteScript(e){var o,n;try{const t=e.tabId||((o=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:o.id);if(!t){sendToWebSocket({type:"browser-script-result",requestId:e.requestId,success:!1,error:"No active tab found"});return}const s=(n=(await chrome.scripting.executeScript({target:{tabId:t,allFrames:e.allFrames||!1},func:r=>{var c;try{if(r==="document.links"||r.includes("document.links"))return{success:!0,result:[...document.links].map(d=>{var u;return{text:((u=d.textContent)==null?void 0:u.trim())||"",href:d.href}})};if(r==="document.title")return{success:!0,result:document.title};if(r.includes("outerHTML")||r.includes("innerHTML"))return{success:!0,result:document.documentElement.outerHTML.slice(0,1e4)};if(r.includes("document.images"))return{success:!0,result:[...document.images].map(d=>({src:d.src,alt:d.alt}))};if(r.includes("textContent")||r.includes("innerText"))return{success:!0,result:document.body.innerText.slice(0,1e4)};const i=r.match(/querySelector\(['"]([^'"]+)['"]\)/);if(i){const l=document.querySelector(i[1]);return l?{success:!0,result:{tagName:l.tagName,text:(c=l.textContent)==null?void 0:c.trim(),html:l.outerHTML.slice(0,1e3)}}:{success:!1,error:`Element not found: ${i[1]}`}}const m=r.match(/querySelectorAll\(['"]([^'"]+)['"]\)/);if(m)return{success:!0,result:[...document.querySelectorAll(m[1])].slice(0,100).map(u=>{var g;return{tagName:u.tagName,text:(g=u.textContent)==null?void 0:g.trim()}})};if(r.includes("localStorage")){const l={};for(let d=0;d<localStorage.length;d++){const u=localStorage.key(d);u&&(l[u]=localStorage.getItem(u)||"")}return{success:!0,result:l}}return{success:!1,error:'Arbitrary code execution blocked by CSP. Use predefined operations: document.links, document.title, document.images, querySelector("selector"), querySelectorAll("selector"), localStorage, textContent, outerHTML'}}catch(i){return{success:!1,error:i.message}}},args:[e.code]}))[0])==null?void 0:n.result;sendToWebSocket({type:"browser-script-result",requestId:e.requestId,success:(s==null?void 0:s.success)||!1,result:s==null?void 0:s.result,error:s==null?void 0:s.error})}catch(t){sendToWebSocket({type:"browser-script-result",requestId:e.requestId,success:!1,error:t.message})}}async function handleBrowserGetPageInfo(e){try{const n=(e.tabId?[await chrome.tabs.get(e.tabId)]:await chrome.tabs.query({active:!0,currentWindow:!0}))[0];sendToWebSocket(n?{type:"browser-page-info",requestId:e.requestId,url:n.url||"",title:n.title||"",tabId:n.id||-1,favIconUrl:n.favIconUrl}:{type:"browser-page-info",requestId:e.requestId,url:"",title:"",tabId:-1,error:"No active tab found"})}catch(o){sendToWebSocket({type:"browser-page-info",requestId:e.requestId,url:"",title:"",tabId:-1,error:o.message})}}console.log("Terminal Tabs background service worker starting...");function connectWebSocket(){if((ws==null?void 0:ws.readyState)===WebSocket.OPEN){console.log("WebSocket already connected");return}if((ws==null?void 0:ws.readyState)===WebSocket.CONNECTING){console.log("WebSocket already connecting, waiting...");return}if(ws){try{ws.close()}catch{}ws=null}console.log("Connecting to backend WebSocket:",WS_URL),ws=new WebSocket(WS_URL),ws.onopen=()=>{console.log("‚úÖ Background WebSocket connected"),wsReconnectAttempts=0,chrome.alarms.clear(ALARM_WS_RECONNECT),updateBadge(),broadcastToClients({type:"WS_CONNECTED"})},ws.onmessage=e=>{var o,n;try{const t=JSON.parse(e.data);if(t.type==="output"||t.type==="terminal-output")broadcastToClients({type:"TERMINAL_OUTPUT",terminalId:t.terminalId,data:t.data});else if(t.type==="terminals"){console.log("üìã Terminal list received:",(o=t.data)==null?void 0:o.length,"terminals");const a=((n=t.data)==null?void 0:n.length)||0;chrome.action.setBadgeText({text:a>0?String(a):""}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),broadcastToClients({type:"WS_MESSAGE",data:t})}else if(t.type==="terminal-spawned"){console.log("üì§ Terminal spawned, broadcasting to clients");const a={type:"WS_MESSAGE",data:t};console.log("üì§ Broadcasting to clients:",JSON.stringify(a).slice(0,200)),broadcastToClients(a),chrome.action.getBadgeText({},s=>{const r=s?parseInt(s):0;chrome.action.setBadgeText({text:String(r+1)}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"})})}else t.type==="terminal-closed"?(console.log("üì§ Terminal closed, broadcasting to clients"),broadcastToClients({type:"WS_MESSAGE",data:t}),chrome.action.getBadgeText({},a=>{const s=a?parseInt(a):0,r=Math.max(0,s-1);chrome.action.setBadgeText({text:r>0?String(r):""}),r>0&&chrome.action.setBadgeBackgroundColor({color:"#4CAF50"})})):t.type==="browser-execute-script"?(console.log("üîß Browser MCP: execute-script request",t.requestId),handleBrowserExecuteScript(t)):t.type==="browser-get-page-info"?(console.log("üîß Browser MCP: get-page-info request",t.requestId),handleBrowserGetPageInfo(t)):broadcastToClients({type:"WS_MESSAGE",data:t})}catch(t){console.error("Failed to parse WebSocket message:",t)}},ws.onerror=e=>{console.error("‚ùå WebSocket error:",{url:WS_URL,readyState:ws==null?void 0:ws.readyState,readyStateText:(ws==null?void 0:ws.readyState)===0?"CONNECTING":(ws==null?void 0:ws.readyState)===1?"OPEN":(ws==null?void 0:ws.readyState)===2?"CLOSING":(ws==null?void 0:ws.readyState)===3?"CLOSED":"UNKNOWN",error:e})},ws.onclose=e=>{console.log("WebSocket closed:",{code:e.code,reason:e.reason||"(no reason provided)",wasClean:e.wasClean,url:WS_URL}),ws=null,broadcastToClients({type:"WS_DISCONNECTED"}),scheduleReconnect()}}function sendToWebSocket(e){console.log("[Background] sendToWebSocket called, ws state:",ws==null?void 0:ws.readyState,"data:",e),(ws==null?void 0:ws.readyState)===WebSocket.OPEN?(console.log("[Background] ‚úÖ Sending to WebSocket:",JSON.stringify(e)),ws.send(JSON.stringify(e))):(console.error("[Background] ‚ùå WebSocket not connected! State:",ws==null?void 0:ws.readyState,"Cannot send:",e),(!ws||ws.readyState===WebSocket.CLOSED)&&(console.log("[Background] Attempting to reconnect WebSocket..."),connectWebSocket()))}function broadcastToClients(e){connectedClients.forEach(o=>{try{o.postMessage(e)}catch(n){console.error("Failed to send message to client:",n),connectedClients.delete(o)}})}async function updateBadge(){(ws==null?void 0:ws.readyState)===WebSocket.OPEN?sendToWebSocket({type:"list-terminals"}):chrome.action.setBadgeText({text:""})}function scheduleReconnect(){if(wsReconnectAttempts>=MAX_RECONNECT_ATTEMPTS){console.log("üõë Max reconnect attempts reached, stopping auto-reconnect");return}const e=Math.min(30,Math.pow(2,wsReconnectAttempts)*.5);wsReconnectAttempts++,console.log(`‚è∞ Scheduling WebSocket reconnect in ${e}s (attempt ${wsReconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`),chrome.alarms.create(ALARM_WS_RECONNECT,{delayInMinutes:e/60})}async function initializeAlarms(){await chrome.alarms.clear(ALARM_SESSION_HEALTH),chrome.alarms.create(ALARM_SESSION_HEALTH,{delayInMinutes:1,periodInMinutes:5}),console.log("‚è∞ Session health check alarm initialized (every 5 minutes)")}chrome.alarms.onAlarm.addListener(e=>{console.log("‚è∞ Alarm fired:",e.name),e.name===ALARM_WS_RECONNECT?(console.log("‚è∞ WebSocket reconnect alarm triggered"),connectWebSocket()):e.name===ALARM_SESSION_HEALTH&&(console.log("‚è∞ Session health check alarm triggered"),(ws==null?void 0:ws.readyState)===WebSocket.OPEN?sendToWebSocket({type:"list-terminals"}):(console.log("‚ö†Ô∏è WebSocket not connected during health check, attempting reconnect"),connectWebSocket()))});chrome.omnibox.setDefaultSuggestion({description:'Run command in terminal: <match>%s</match> (or type "profile:name", "new", "help", or a URL)'});const ALLOWED_URL_PATTERNS=[/^https?:\/\/(www\.)?github\.com(\/.*)?$/i,/^https?:\/\/(www\.)?gitlab\.com(\/.*)?$/i,/^https?:\/\/localhost(:\d+)?(\/.*)?$/i,/^https?:\/\/127\.0\.0\.1(:\d+)?(\/.*)?$/i,/^https?:\/\/[\w-]+\.vercel\.app(\/.*)?$/i,/^https?:\/\/[\w.-]+\.vercel\.com(\/.*)?$/i];function isAllowedUrl(e){let o=e.trim();if(!o.match(/^https?:\/\//i))if(o.match(/^(www\.)?(github\.com|gitlab\.com|localhost|127\.0\.0\.1)/i))o=`https://${o}`;else if(o.match(/^[\w-]+\.vercel\.(app|com)/i))o=`https://${o}`;else return{allowed:!1};for(const n of ALLOWED_URL_PATTERNS)if(n.test(o))return{allowed:!0,url:o};return{allowed:!1}}chrome.omnibox.onInputChanged.addListener(async(e,o)=>{const n=[],t=e.toLowerCase().trim(),a=isAllowedUrl(e);if(a.allowed&&a.url&&n.push({content:`url:${a.url}`,description:`<match>Open URL:</match> ${a.url} <dim>(in new tab)</dim>`}),t.startsWith("profile:")||t==="p"||t==="pr")try{const c=(await chrome.storage.local.get(["profiles"])).profiles||[];for(const i of c)n.push({content:`profile:${i.id}`,description:`<match>Profile:</match> ${i.name} <dim>(${i.workingDir||"~"})</dim>`})}catch(r){console.error("Failed to get profiles for omnibox:",r)}("new".startsWith(t)||t==="")&&n.push({content:"new",description:"<match>new</match> - Open new terminal with default profile"}),"help".startsWith(t)&&n.push({content:"help",description:"<match>help</match> - Show available commands"});const s=[{cmd:"git status",desc:"Check git repository status"},{cmd:"git pull",desc:"Pull latest changes"},{cmd:"npm install",desc:"Install npm dependencies"},{cmd:"npm run dev",desc:"Start development server"},{cmd:"docker ps",desc:"List running containers"}];for(const{cmd:r,desc:c}of s)r.toLowerCase().includes(t)&&t.length>1&&n.push({content:r,description:`<match>${r}</match> <dim>- ${c}</dim>`});o(n.slice(0,5))});chrome.omnibox.onInputEntered.addListener(async(e,o)=>{console.log("üîç Omnibox command:",e,"disposition:",o);const n=e.toLowerCase().trim();if(e.startsWith("url:")){const r=e.substring(4);console.log("üåê Opening URL from omnibox:",r),o==="currentTab"?chrome.tabs.update({url:r}):chrome.tabs.create({url:r,active:o==="newForegroundTab"});return}const t=isAllowedUrl(e);if(t.allowed&&t.url){console.log("üåê Opening URL from omnibox (direct):",t.url),o==="currentTab"?chrome.tabs.update({url:t.url}):chrome.tabs.create({url:t.url,active:o==="newForegroundTab"});return}const a=await chrome.windows.getAll({windowTypes:["normal"]}),s=a.find(r=>r.focused)||a[0];if(s!=null&&s.id)try{await chrome.sidePanel.open({windowId:s.id})}catch(r){console.error("Failed to open sidebar from omnibox:",r)}if(n==="new"){broadcastToClients({type:"KEYBOARD_NEW_TAB"});return}if(n==="help"){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Terminal Tabs - Omnibox Commands",message:'Commands: "new" (new tab), "profile:name" (spawn profile), GitHub/GitLab URLs (open in new tab), or type any bash command to run it.',priority:1});return}if(n.startsWith("profile:")){const r=e.substring(8).trim();try{const m=((await chrome.storage.local.get(["profiles"])).profiles||[]).find(l=>l.id===r||l.name.toLowerCase()===r.toLowerCase());m?setTimeout(()=>{broadcastToClients({type:"OMNIBOX_SPAWN_PROFILE",profile:m})},300):chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Profile Not Found",message:`No profile found with name or ID: ${r}`,priority:1})}catch(c){console.error("Failed to spawn profile from omnibox:",c)}return}setTimeout(()=>{broadcastToClients({type:"OMNIBOX_RUN_COMMAND",command:e})},300)});chrome.runtime.onMessage.addListener(async(message,sender,sendResponse)=>{var e,o,n,t,a,s,r;switch(console.log("üì¨ Message received from extension:",message.type),message.type){case"OPEN_SESSION":try{const c=await chrome.windows.getAll({windowTypes:["normal"]}),i=c.find(m=>m.focused)||c[0];i!=null&&i.id?(console.log("[Background] Opening side panel in window:",i.id),await chrome.sidePanel.open({windowId:i.id})):console.error("[Background] No normal browser window found")}catch(c){console.error("[Background] Failed to open side panel:",c)}sendToWebSocket({type:"attach-terminal",sessionName:message.sessionName});break;case"SPAWN_TERMINAL":const requestId=`spawn-${Date.now()}`,useTmux=!0;console.log("[Background] SPAWN_TERMINAL received:",{spawnOption:message.spawnOption,name:message.name,command:message.command,workingDir:message.workingDir}),sendToWebSocket({type:"spawn",config:{terminalType:message.spawnOption||"bash",command:message.command||"",workingDir:message.workingDir||message.cwd||((e=message.profile)==null?void 0:e.workingDir),useTmux,name:message.name||message.spawnOption||"Terminal",profile:message.profile,isChrome:!0},requestId}),console.log("üì§ Sending to backend:",{terminalType:message.spawnOption||"bash",name:message.name,command:message.command||"(no command)",workingDir:message.workingDir||((o=message.profile)==null?void 0:o.workingDir),useTmux,isChrome:!0,requestId,profile:message.profile});break;case"QUEUE_COMMAND":console.log("[Background] QUEUE_COMMAND received:",message.command);try{const c=await chrome.windows.getAll({windowTypes:["normal"]}),i=c.find(m=>m.focused)||c[0];i!=null&&i.id&&await chrome.sidePanel.open({windowId:i.id})}catch(c){console.error("[Background] Failed to open side panel:",c)}setTimeout(()=>{broadcastToClients({type:"QUEUE_COMMAND",command:message.command})},300);break;case"CLOSE_SESSION":sendToWebSocket({type:"close-terminal",sessionName:message.sessionName});break;case"CLOSE_TERMINAL":sendToWebSocket({type:"close",terminalId:message.terminalId});break;case"TERMINAL_INPUT":console.log("üì• TERMINAL_INPUT:",{terminalId:message.terminalId,dataLength:(n=message.data)==null?void 0:n.length}),sendToWebSocket({type:"command",terminalId:message.terminalId,command:message.data});break;case"TARGETED_PANE_SEND":console.log("üéØ TARGETED_PANE_SEND:",{tmuxPane:message.tmuxPane,textLength:(t=message.text)==null?void 0:t.length,sendEnter:message.sendEnter}),sendToWebSocket({type:"targeted-pane-send",tmuxPane:message.tmuxPane,text:message.text,sendEnter:message.sendEnter});break;case"TERMINAL_RESIZE":console.log("üìè TERMINAL_RESIZE:",{terminalId:message.terminalId,cols:message.cols,rows:message.rows}),sendToWebSocket({type:"resize",terminalId:message.terminalId,cols:message.cols,rows:message.rows});break;case"UPDATE_BADGE":updateBadge();break;case"LIST_TERMINALS":console.log("üìã Requesting terminal list from backend"),sendToWebSocket({type:"list-terminals"});break;case"REFRESH_TERMINALS":console.log("üîÑ Broadcasting REFRESH_TERMINALS to all clients"),broadcastToClients({type:"REFRESH_TERMINALS"});break;case"CONSOLE_LOG":const logEntry={...message.entry,tabId:((a=sender.tab)==null?void 0:a.id)||-1};addConsoleLog(logEntry);break;case"GET_CONSOLE_LOGS":const logs=getConsoleLogs({level:message.level,limit:message.limit,since:message.since,tabId:message.tabId});return sendResponse({type:"CONSOLE_LOGS_RESPONSE",logs,total:consoleLogs.length}),!0;case"BROWSER_EXECUTE_SCRIPT":try{const targetTabId=message.tabId||((s=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:s.id);if(!targetTabId)return sendResponse({type:"BROWSER_SCRIPT_RESULT",success:!1,error:"No active tab found"}),!0;const results=await chrome.scripting.executeScript({target:{tabId:targetTabId,allFrames:message.allFrames||!1},func:code=>{try{return{success:!0,result:eval(code)}}catch(c){return{success:!1,error:c.message}}},args:[message.code]}),result=(r=results[0])==null?void 0:r.result;sendResponse({type:"BROWSER_SCRIPT_RESULT",success:(result==null?void 0:result.success)||!1,result:result==null?void 0:result.result,error:result==null?void 0:result.error})}catch(c){sendResponse({type:"BROWSER_SCRIPT_RESULT",success:!1,error:c.message})}return!0;case"BROWSER_GET_PAGE_INFO":try{const i=(message.tabId?[await chrome.tabs.get(message.tabId)]:await chrome.tabs.query({active:!0,currentWindow:!0}))[0];sendResponse(i?{type:"BROWSER_PAGE_INFO",url:i.url||"",title:i.title||"",tabId:i.id||-1,favIconUrl:i.favIconUrl}:{type:"BROWSER_PAGE_INFO",url:"",title:"",tabId:-1,error:"No active tab found"})}catch(c){sendResponse({type:"BROWSER_PAGE_INFO",url:"",title:"",tabId:-1,error:c.message})}return!0;default:sendToWebSocket(message)}return!0});chrome.runtime.onMessageExternal.addListener(async(e,o,n)=>{var t;switch(console.log("üåê External message received:",e.type,"from:",o.url),e.type){case"PING":n({ok:!0,version:chrome.runtime.getManifest().version});break;case"SPAWN_TERMINAL":try{const s=await chrome.windows.getAll({windowTypes:["normal"]}),r=s.find(c=>c.focused)||s[0];r!=null&&r.id&&await chrome.sidePanel.open({windowId:r.id})}catch(s){console.error("[Background] Failed to open side panel:",s)}const a=`spawn-external-${Date.now()}`;sendToWebSocket({type:"spawn",config:{terminalType:"bash",command:e.command||"",workingDir:e.workingDir,useTmux:!0,name:e.name||((t=e.command)==null?void 0:t.split(" ")[0])||"Terminal",isChrome:!0},requestId:a}),n({ok:!0,requestId:a});break;default:n({ok:!1,error:"Unknown message type"})}return!0});chrome.runtime.onConnect.addListener(e=>{console.log("üîå Client connected:",e.name),connectedClients.add(e);const o=(ws==null?void 0:ws.readyState)===WebSocket.OPEN;e.postMessage({type:"INITIAL_STATE",wsConnected:o}),e.onDisconnect.addListener(()=>{console.log("üîå Client disconnected:",e.name),connectedClients.delete(e)}),e.onMessage.addListener(n=>{chrome.runtime.sendMessage(n)})});function setupContextMenus(){console.log("Setting up context menus..."),chrome.contextMenus.removeAll(()=>{chrome.runtime.lastError&&console.error("Error removing context menus:",chrome.runtime.lastError),chrome.contextMenus.create({id:"open-sidepanel",title:"Open Terminal Sidebar",contexts:["all"]},()=>{chrome.runtime.lastError?console.error("Error creating open-sidepanel menu:",chrome.runtime.lastError):console.log("‚úÖ Open sidebar menu created")}),chrome.contextMenus.create({id:"paste-to-terminal",title:'Paste "%s" to Terminal',contexts:["selection"]},()=>{chrome.runtime.lastError?console.error("Error creating paste-to-terminal menu:",chrome.runtime.lastError):console.log("‚úÖ Paste menu created")}),console.log("‚úÖ Context menus setup complete")})}chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed/updated"),setupContextMenus(),initializeAlarms()});chrome.runtime.onStartup.addListener(()=>{console.log("Service worker started"),setupContextMenus(),initializeAlarms()});setTimeout(()=>{console.log("Delayed context menu setup (for dev reload)"),setupContextMenus()},100);chrome.contextMenus.onClicked.addListener(async(e,o)=>{console.log("Context menu clicked:",e.menuItemId);const n=e.menuItemId,t=async()=>{if(o!=null&&o.windowId&&o.windowId>0)return o.windowId;const a=await chrome.windows.getAll({windowTypes:["normal"]}),s=a.find(r=>r.focused)||a[0];return s==null?void 0:s.id};if(n==="open-sidepanel"||n==="toggle-sidepanel"){try{const a=await t();a&&await chrome.sidePanel.open({windowId:a})}catch(a){console.debug("[Background] Sidebar open attempt:",a)}return}if(n==="paste-to-terminal"&&e.selectionText){const a=e.selectionText;console.log("üìã Pasting to terminal:",a);try{const s=await t();s&&(await chrome.sidePanel.open({windowId:s}),setTimeout(()=>{broadcastToClients({type:"PASTE_COMMAND",command:a})},500))}catch(s){console.error("[Background] Failed to open sidebar for paste:",s)}}});chrome.action.onClicked.addListener(async e=>{if(console.log("üñ±Ô∏è Extension icon clicked"),e.windowId)try{await chrome.sidePanel.open({windowId:e.windowId}),console.log("[Background] Opened sidebar via icon click")}catch(o){console.error("[Background] Failed to open sidebar:",o)}});chrome.commands.onCommand.addListener(async e=>{var a;console.log("‚å®Ô∏è Keyboard command:",e);const o=await chrome.windows.getAll({windowTypes:["normal"]}),n=o.find(s=>s.focused)||o[0];if(e==="toggle-sidebar"){try{n!=null&&n.id?(console.log("[Background] Toggling sidebar in window:",n.id),await chrome.sidePanel.open({windowId:n.id})):console.error("[Background] No normal browser window found")}catch(s){console.error("[Background] Failed to toggle sidebar:",s),s instanceof Error&&s.message.includes("user gesture")&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Terminal Sidebar",message:"Please click the extension icon to open the sidebar. Chrome doesn't allow keyboard shortcuts to open side panels.",priority:1})}return}if(e==="new-tab"){console.log("[Background] New tab shortcut triggered"),broadcastToClients({type:"KEYBOARD_NEW_TAB"});return}if(e==="close-tab"){console.log("[Background] Close tab shortcut triggered"),broadcastToClients({type:"KEYBOARD_CLOSE_TAB"});return}if(e==="next-tab"){console.log("[Background] Next tab shortcut triggered"),broadcastToClients({type:"KEYBOARD_NEXT_TAB"});return}if(e==="prev-tab"){console.log("[Background] Prev tab shortcut triggered"),broadcastToClients({type:"KEYBOARD_PREV_TAB"});return}const t=e.match(/^tab-(\d)$/);if(t){const s=parseInt(t[1])-1;console.log("[Background] Switch to tab shortcut:",s),broadcastToClients({type:"KEYBOARD_SWITCH_TAB",tabIndex:s});return}if(e==="paste-selection"){console.log("[Background] Paste selection shortcut triggered");try{const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});if(s!=null&&s.id){const c=(a=(await chrome.scripting.executeScript({target:{tabId:s.id},func:()=>{var i;return((i=window.getSelection())==null?void 0:i.toString())||""}}))[0])==null?void 0:a.result;if(c){if(console.log("[Background] üìã Pasting selection to terminal:",c.substring(0,50)+"..."),n!=null&&n.id)try{await chrome.sidePanel.open({windowId:n.id})}catch{}broadcastToClients({type:"PASTE_COMMAND",command:c})}else console.log("[Background] No text selected")}}catch(s){console.error("[Background] Failed to get selection:",s)}return}});connectWebSocket();setInterval(()=>{console.log("üèì Background service worker alive"),(ws==null?void 0:ws.readyState)!==WebSocket.OPEN&&connectWebSocket()},25e3);console.log("‚úÖ Terminal Tabs background service worker initialized");
