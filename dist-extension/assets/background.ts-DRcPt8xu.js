let o=null,k=null;const T=5e3,m="ws://localhost:8129",S=new Set;console.log("Terminal Tabs background service worker starting...");function p(){if((o==null?void 0:o.readyState)===WebSocket.OPEN){console.log("WebSocket already connected");return}console.log("Connecting to backend WebSocket:",m),o=new WebSocket(m),o.onopen=()=>{console.log("âœ… Background WebSocket connected"),y(),c({type:"WS_CONNECTED"})},o.onmessage=e=>{var n,r,l,g;try{const t=JSON.parse(e.data);if(console.log("ğŸ“¨ WS message received:",t.type,t.type==="terminal-spawned"?JSON.stringify(t).slice(0,200):""),t.type==="output"||t.type==="terminal-output")console.log("ğŸ“Ÿ Terminal output received, broadcasting to clients:",(n=t.terminalId)==null?void 0:n.slice(-8),(r=t.data)==null?void 0:r.length,"bytes"),c({type:"TERMINAL_OUTPUT",terminalId:t.terminalId,data:t.data});else if(t.type==="terminals"){console.log("ğŸ“‹ Terminal list received:",(l=t.data)==null?void 0:l.length,"terminals");const i=((g=t.data)==null?void 0:g.length)||0;chrome.action.setBadgeText({text:i>0?String(i):""}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),c({type:"WS_MESSAGE",data:t})}else if(t.type==="terminal-spawned"){console.log("ğŸ“¤ Terminal spawned, broadcasting to clients");const i={type:"WS_MESSAGE",data:t};console.log("ğŸ“¤ Broadcasting to clients:",JSON.stringify(i).slice(0,200)),c(i),chrome.action.getBadgeText({},s=>{const a=s?parseInt(s):0;chrome.action.setBadgeText({text:String(a+1)}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"})})}else t.type==="terminal-closed"?(console.log("ğŸ“¤ Terminal closed, broadcasting to clients"),c({type:"WS_MESSAGE",data:t}),chrome.action.getBadgeText({},i=>{const s=i?parseInt(i):0,a=Math.max(0,s-1);chrome.action.setBadgeText({text:a>0?String(a):""}),a>0&&chrome.action.setBadgeBackgroundColor({color:"#4CAF50"})})):c({type:"WS_MESSAGE",data:t})}catch(t){console.error("Failed to parse WebSocket message:",t)}},o.onerror=e=>{console.error("âŒ WebSocket error:",{url:m,readyState:o==null?void 0:o.readyState,readyStateText:(o==null?void 0:o.readyState)===0?"CONNECTING":(o==null?void 0:o.readyState)===1?"OPEN":(o==null?void 0:o.readyState)===2?"CLOSING":(o==null?void 0:o.readyState)===3?"CLOSED":"UNKNOWN",error:e})},o.onclose=e=>{console.log("WebSocket closed:",{code:e.code,reason:e.reason||"(no reason provided)",wasClean:e.wasClean,url:m}),o=null,c({type:"WS_DISCONNECTED"}),k&&clearTimeout(k),k=setTimeout(p,T)}}function d(e){console.log("[Background] sendToWebSocket called, ws state:",o==null?void 0:o.readyState,"data:",e),(o==null?void 0:o.readyState)===WebSocket.OPEN?(console.log("[Background] âœ… Sending to WebSocket:",JSON.stringify(e)),o.send(JSON.stringify(e))):(console.error("[Background] âŒ WebSocket not connected! State:",o==null?void 0:o.readyState,"Cannot send:",e),(!o||o.readyState===WebSocket.CLOSED)&&(console.log("[Background] Attempting to reconnect WebSocket..."),p()))}function c(e){S.forEach(n=>{try{n.postMessage(e)}catch(r){console.error("Failed to send message to client:",r),S.delete(n)}})}async function y(){(o==null?void 0:o.readyState)===WebSocket.OPEN?d({type:"list-terminals"}):chrome.action.setBadgeText({text:""})}chrome.runtime.onMessage.addListener(async(e,n,r)=>{var l,g,t;switch(console.log("ğŸ“¬ Message received from extension:",e.type),e.type){case"OPEN_SESSION":try{const a=await chrome.windows.getAll({windowTypes:["normal"]}),u=a.find(w=>w.focused)||a[0];u!=null&&u.id?(console.log("[Background] Opening side panel in window:",u.id),await chrome.sidePanel.open({windowId:u.id})):console.error("[Background] No normal browser window found")}catch(a){console.error("[Background] Failed to open side panel:",a)}d({type:"attach-terminal",sessionName:e.sessionName});break;case"SPAWN_TERMINAL":const i=`spawn-${Date.now()}`,s=!0;console.log("[Background] SPAWN_TERMINAL received:",{spawnOption:e.spawnOption,name:e.name,command:e.command,workingDir:e.workingDir}),d({type:"spawn",config:{terminalType:e.spawnOption||"bash",command:e.command||"",workingDir:e.workingDir||e.cwd||((l=e.profile)==null?void 0:l.workingDir),useTmux:s,name:e.name||e.spawnOption||"Terminal",profile:e.profile,isChrome:!0},requestId:i}),console.log("ğŸ“¤ Sending to backend:",{terminalType:e.spawnOption||"bash",name:e.name,command:e.command||"(no command)",workingDir:e.workingDir||((g=e.profile)==null?void 0:g.workingDir),useTmux:s,isChrome:!0,requestId:i});break;case"CLOSE_SESSION":d({type:"close-terminal",sessionName:e.sessionName});break;case"CLOSE_TERMINAL":d({type:"close",terminalId:e.terminalId});break;case"TERMINAL_INPUT":console.log("ğŸ“¥ TERMINAL_INPUT:",{terminalId:e.terminalId,dataLength:(t=e.data)==null?void 0:t.length}),d({type:"command",terminalId:e.terminalId,command:e.data});break;case"TERMINAL_RESIZE":console.log("ğŸ“ TERMINAL_RESIZE:",{terminalId:e.terminalId,cols:e.cols,rows:e.rows}),d({type:"resize",terminalId:e.terminalId,cols:e.cols,rows:e.rows});break;case"UPDATE_BADGE":y();break;case"LIST_TERMINALS":console.log("ğŸ“‹ Requesting terminal list from backend"),d({type:"list-terminals"});break;case"REFRESH_TERMINALS":console.log("ğŸ”„ Broadcasting REFRESH_TERMINALS to all clients"),c({type:"REFRESH_TERMINALS"});break;default:d(e)}return!0});chrome.runtime.onConnect.addListener(e=>{console.log("ğŸ”Œ Client connected:",e.name),S.add(e);const n=(o==null?void 0:o.readyState)===WebSocket.OPEN;e.postMessage({type:"INITIAL_STATE",wsConnected:n}),e.onDisconnect.addListener(()=>{console.log("ğŸ”Œ Client disconnected:",e.name),S.delete(e)}),e.onMessage.addListener(r=>{chrome.runtime.sendMessage(r)})});function E(){console.log("Setting up context menus..."),chrome.contextMenus.removeAll(()=>{chrome.runtime.lastError&&console.error("Error removing context menus:",chrome.runtime.lastError),chrome.contextMenus.create({id:"toggle-sidepanel",title:"Toggle Terminal Sidebar",contexts:["all"]},()=>{chrome.runtime.lastError?console.error("Error creating toggle-sidepanel menu:",chrome.runtime.lastError):console.log("âœ… Toggle menu created")}),chrome.contextMenus.create({id:"paste-to-terminal",title:'Paste "%s" to Terminal',contexts:["selection"]},()=>{chrome.runtime.lastError?console.error("Error creating paste-to-terminal menu:",chrome.runtime.lastError):console.log("âœ… Paste menu created")}),console.log("âœ… Context menus setup complete")})}chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed/updated"),E()});chrome.runtime.onStartup.addListener(()=>{console.log("Service worker started"),E()});setTimeout(()=>{console.log("Delayed context menu setup (for dev reload)"),E()},100);chrome.contextMenus.onClicked.addListener(async(e,n)=>{console.log("Context menu clicked:",e.menuItemId);const r=e.menuItemId;if(r==="toggle-sidepanel"&&(n!=null&&n.windowId)){chrome.sidePanel.open({windowId:n.windowId});return}if(r==="paste-to-terminal"&&e.selectionText&&(n!=null&&n.windowId)){const l=e.selectionText;console.log("ğŸ“‹ Pasting to terminal:",l),await chrome.sidePanel.open({windowId:n.windowId}),setTimeout(()=>{c({type:"PASTE_COMMAND",command:l})},500)}});chrome.action.onClicked.addListener(async e=>{if(console.log("ğŸ–±ï¸ Extension icon clicked"),e.windowId)try{await chrome.sidePanel.open({windowId:e.windowId}),console.log("[Background] Opened sidebar via icon click")}catch(n){console.error("[Background] Failed to open sidebar:",n)}});chrome.commands.onCommand.addListener(async e=>{var g;console.log("âŒ¨ï¸ Keyboard command:",e);const n=await chrome.windows.getAll({windowTypes:["normal"]}),r=n.find(t=>t.focused)||n[0];if(e==="toggle-sidebar"){try{r!=null&&r.id?(console.log("[Background] Toggling sidebar in window:",r.id),await chrome.sidePanel.open({windowId:r.id})):console.error("[Background] No normal browser window found")}catch(t){console.error("[Background] Failed to toggle sidebar:",t),t instanceof Error&&t.message.includes("user gesture")&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Terminal Sidebar",message:"Please click the extension icon to open the sidebar. Chrome doesn't allow keyboard shortcuts to open side panels.",priority:1})}return}if(e==="new-tab"){console.log("[Background] New tab shortcut triggered"),c({type:"KEYBOARD_NEW_TAB"});return}if(e==="close-tab"){console.log("[Background] Close tab shortcut triggered"),c({type:"KEYBOARD_CLOSE_TAB"});return}if(e==="next-tab"){console.log("[Background] Next tab shortcut triggered"),c({type:"KEYBOARD_NEXT_TAB"});return}if(e==="prev-tab"){console.log("[Background] Prev tab shortcut triggered"),c({type:"KEYBOARD_PREV_TAB"});return}const l=e.match(/^tab-(\d)$/);if(l){const t=parseInt(l[1])-1;console.log("[Background] Switch to tab shortcut:",t),c({type:"KEYBOARD_SWITCH_TAB",tabIndex:t});return}if(e==="paste-selection"){console.log("[Background] Paste selection shortcut triggered");try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id){const s=(g=(await chrome.scripting.executeScript({target:{tabId:t.id},func:()=>{var a;return((a=window.getSelection())==null?void 0:a.toString())||""}}))[0])==null?void 0:g.result;if(s){if(console.log("[Background] ğŸ“‹ Pasting selection to terminal:",s.substring(0,50)+"..."),r!=null&&r.id)try{await chrome.sidePanel.open({windowId:r.id})}catch{}c({type:"PASTE_COMMAND",command:s})}else console.log("[Background] No text selected")}}catch(t){console.error("[Background] Failed to get selection:",t)}return}});p();setInterval(()=>{console.log("ğŸ“ Background service worker alive"),(o==null?void 0:o.readyState)!==WebSocket.OPEN&&p()},25e3);console.log("âœ… Terminal Tabs background service worker initialized");
